<!-- FORM 3: Artist Edit Event Form -->
<div class="container pt-4" style="max-width: 600px;">
  <h2 class="mb-4 text-center">Edit Event</h2>

  <%= form_with model: event, local: true, class: "needs-validation",
      data: {
        controller: "time-options artist-category-warning conflict-checker",
        conflict_checker_endpoint_value: "/events/conflicts_ajax",
        artist_category_warning_artist_performance_type_value: (event.artist&.performance_type || ""),
        artist_category_warning_is_edit_value: "true"
      } do |f| %>

    <!-- Primary artist (read-only) -->
    <div class="mb-3">
      <label class="form-label fw-bold">Artist</label>
      <p class="form-control-plaintext text-muted mb-0">
        <% if event.artist.present? %>
          <%= event.artist.username %>
        <% else %>
          <%= event.artist_name %>
        <% end %>
      </p>
      <!-- Preserve primary selection for backend sanity -->
      <% if event.artist_id.present? %>
        <%= hidden_field_tag "event[artist_id]", event.artist_id %>
      <% else %>
        <%= hidden_field_tag "event[artist_name]", event.artist_name %>
      <% end %>
    </div>

    <!-- Venue (read-only display, but provide slug for JS controllers) -->
    <div class="mb-3">
      <label class="form-label fw-bold">Venue</label>
      <p class="form-control-plaintext text-muted mb-0"><%= event.venue.name %></p>
      <%= hidden_field_tag "event[venue_slug]", event.venue.slug,
            data: {
              time_options_target: "venue",
              conflict_checker_target: "venue",
              action: "change->conflict-checker#venueChanged"
            } %>
    </div>

    <!-- Additional Artists (Artist Edit) -->
    <div class="mb-3" data-controller="multi-artists" data-multi-artists-max-value="5">
      <div class="form-check mb-2">
        <%# If there are existing additional artists, open the container %>
        <% expanded = event.event_artists.any? %>
        <input class="form-check-input" type="checkbox" id="artist_edit_addl_toggle"
               data-action="change->multi-artists#toggle"
               data-multi-artists-target="toggle"
               <%= "checked" if expanded %>>
        <label class="form-check-label" for="artist_edit_addl_toggle">
          Additional artists at this show
        </label>
      </div>

      <div class="<%= expanded ? '' : 'd-none' %> border rounded p-3 bg-light" data-multi-artists-target="container">
        <div data-multi-artists-target="rows">
          <%# Pre-render existing rows %>
          <% event.event_artists.each_with_index do |ea, idx| %>
            <div class="border rounded p-2 mb-2 bg-white">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Artist <%= idx + 1 %></strong>
                <button type="button"
                        class="btn btn-sm btn-link text-danger"
                        data-action="multi-artists#removeRow">Remove</button>
              </div>

              <% if ea.artist_id.present? %>
                <!-- DB-picked existing row -->
                <div class="mb-2" data-db-wrapper>
                  <div class="position-relative" data-controller="inline-artist-autocomplete">
                    <input type="text" class="form-control pe-5"
                           placeholder="Search artist..."
                           value="<%= ea.artist.username %>"
                           data-inline-artist-autocomplete-target="input" autocomplete="off" />
                    <ul class="list-group small mt-1 position-absolute w-100"
                        data-inline-artist-autocomplete-target="results"
                        style="z-index:1000; max-height:200px; overflow:auto;"></ul>

                    <input type="hidden" name="event[additional_artist_ids][]"
                           value="<%= ea.artist_id %>"
                           data-inline-artist-autocomplete-target="hidden" />

                    <div class="border border-info rounded p-2 bg-info-subtle mt-2"
                         data-inline-artist-autocomplete-target="details">
                      <div class="d-flex align-items-start gap-2">
                        <div class="flex-shrink-0" data-inline-artist-autocomplete-target="imageContainer">
                          <% if ea.artist.image.attached? %>
                            <%= image_tag ea.artist.image.variant(resize_to_fill: [80, 80]).processed,
                                          class: "rounded-circle",
                                          style: "width:80px;height:80px;object-fit:cover;" %>
                          <% end %>
                        </div>
                        <div class="flex-grow-1">
                          <p class="mb-1"><strong>Username:</strong>
                            <span data-inline-artist-autocomplete-target="username"><%= ea.artist.username %></span>
                          </p>
                          <p class="mb-0 text-muted small" data-inline-artist-autocomplete-target="bio"><%= ea.artist.bio %></p>
                        </div>
                      </div>

                      <div class="form-check mt-2">
                        <input type="hidden" name="event[additional_artist_verified][]" value="1"
                               data-inline-artist-autocomplete-target="verifiedField">
                        <input class="form-check-input" type="checkbox"
                               data-inline-artist-autocomplete-target="verification"
                               checked>
                        <label class="form-check-label">
                          <strong>Yes, this is the correct artist for my event</strong>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Manual wrapper (hidden since DB mode) -->
                <div class="mb-2 d-none" data-manual-wrapper>
                  <input type="text" class="form-control"
                         name="event[additional_manual_names][]" placeholder="Enter artist name" />
                </div>

              <% else %>
                <!-- Manual existing row -->
                <div class="mb-2 form-check">
                  <input class="form-check-input" type="checkbox" checked
                         data-action="multi-artists#toggleManual" />
                  <label class="form-check-label">This Artist isn't on Pickleball</label>
                </div>

                <!-- DB wrapper hidden -->
                <div class="mb-2 d-none" data-db-wrapper>
                  <div class="position-relative" data-controller="inline-artist-autocomplete">
                    <input type="text" class="form-control pe-5" placeholder="Search artist..."
                           data-inline-artist-autocomplete-target="input" autocomplete="off" />
                    <ul class="list-group small mt-1 position-absolute w-100"
                        data-inline-artist-autocomplete-target="results"
                        style="z-index:1000; max-height:200px; overflow:auto;"></ul>

                    <input type="hidden" name="event[additional_artist_ids][]"
                           data-inline-artist-autocomplete-target="hidden" />

                    <div class="border border-info rounded p-2 bg-info-subtle mt-2 d-none"
                         data-inline-artist-autocomplete-target="details">
                      <!-- will be filled if user switches from manual to DB -->
                      <div class="form-check mt-2">
                        <input type="hidden" name="event[additional_artist_verified][]" value="0"
                               data-inline-artist-autocomplete-target="verifiedField">
                        <input class="form-check-input" type="checkbox"
                               data-inline-artist-autocomplete-target="verification">
                        <label class="form-check-label">
                          <strong>Yes, this is the correct artist for my event</strong>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Manual wrapper visible -->
                <div class="mb-2" data-manual-wrapper>
                  <input type="text" class="form-control"
                         name="event[additional_manual_names][]"
                         value="<%= ea.manual_name %>"
                         placeholder="Enter artist name" />
                </div>
              <% end %>
            </div>
          <% end %>
        </div>

        <div class="d-flex justify-content-between mt-2">
          <button type="button" class="btn btn-outline-secondary btn-sm"
                  data-action="multi-artists#addRow">Add another artist</button>
          <span class="text-muted small">(max 5)</span>
        </div>
      </div>
    </div>

    <!-- Category -->
    <div class="mb-3">
      <%= f.label :category, class: "form-label" %>
      <%= f.select :category,
            Artist::PERFORMANCE_TYPES.map { |type| [type, type] },
            { selected: event.category },
            {
              class: "form-select",
              required: true,
              data: {
                artist_category_warning_target: "category",
                action: "change->artist-category-warning#checkCategory"
              }
            } %>
      <div class="small text-muted mt-1 d-none" data-artist-category-warning-target="warning">
        This differs from your profile and will only apply to this event
      </div>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <%= f.label :description, class: "form-label fw-bold" %>
      <%= f.text_area :description,
            class: "form-control",
            placeholder: "Describe the event",
            rows: 3 %>
    </div>

    <!-- Date -->
    <div class="mb-3">
      <%= f.label :date, class: "form-label fw-bold" %>
      <%= f.select :date, [["Select date", ""]], {},
          class: "form-select", required: true,
          data: {
            time_options_target: "date",
            conflict_checker_target: "date",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.to_date&.to_s),
            action: "change->time-options#updateStartTimes change->conflict-checker#dateChanged"
          } %>
    </div>

    <!-- Start Time -->
    <div class="mb-3">
      <%= f.label :start_time, "Start Time", class: "form-label fw-bold" %>
      <%= f.select :start_time, [["Select start time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "startTime",
            conflict_checker_target: "startTime",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->time-options#updateEndTimes change->conflict-checker#startTimeChanged"
          } %>
    </div>

    <!-- End Time -->
    <div class="mb-3">
      <%= f.label :end_time, "End Time", class: "form-label fw-bold" %>
      <%= f.select :end_time, [["Select end time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "endTime",
            conflict_checker_target: "endTime",
            default_value: (event.end_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->conflict-checker#endTimeChanged"
          } %>
    </div>

    <!-- Live conflict banner -->
    <div class="mb-2" data-conflict-checker-target="flash"></div>

    <%= f.hidden_field :cover, value: "0" %>
    <%= f.hidden_field :cover_amount, value: nil %>

    <!-- Outdoors Checkbox -->
    <div class="form-check mb-4">
      <%= f.check_box :indoors,
            { checked: event.outdoors?, class: "form-check-input" },
            "0",
            "1" %>
      <%= f.label :indoors, "Outdoors?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Exclude self from conflict check -->
    <input type="hidden" value="<%= event.id %>" data-conflict-checker-target="excludeId">

    <div class="d-grid">
      <%= f.submit "Update Event",
            class: "btn btn-primary",
            data: { conflict_checker_target: "submit" } %>
    </div>

    <!-- GLOBAL reasons why submit is disabled -->
    <div class="small mt-2 d-none">
      <div data-submit-help class="text-danger"></div>
    </div>

  <% end %>
</div>
