<% content_for :title, "Event Information" %>

<style>
  .event-profile-card {
    border-radius: 24px;
    background: white;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    transition: all 0.3s ease;
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .artist-image-circle {
    position: relative;
    display: inline-block;
    animation: scaleIn 0.8s ease-out both;
  }

  .artist-image-circle::after {
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    z-index: -1;
    opacity: 0.15;
  }

  .event-time-badge-large {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    padding: 0.6rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    box-shadow: 0 6px 15px rgba(13, 110, 253, 0.3);
  }

  .event-details-card {
    border-radius: 24px;
    background: white;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    animation: fadeInUp 0.6s ease-out 0.2s both;
  }

  .detail-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
  }

  .detail-box:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  }

  .live-badge {
    animation: pulseGlow 1.5s infinite;
  }

  @keyframes pulseGlow {
    0%, 100% {
      opacity: 1;
      box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
    }
    50% {
      opacity: 0.7;
      box-shadow: 0 0 20px rgba(25, 135, 84, 0.8);
    }
  }

  .map-btn-modern {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    font-weight: 600;
    box-shadow: 0 6px 15px rgba(13, 110, 253, 0.3);
    transition: all 0.3s ease;
  }

  .map-btn-modern:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(13, 110, 253, 0.4);
  }
</style>

<div class="min-vh-100" style="background-color: #f8f9fa;">
  <div class="px-3 pt-4" style="max-width: 500px; margin: 0 auto;">

    <!-- Event Profile Card -->
    <div class="card border-0 event-profile-card mb-4 position-relative">
      <!-- Live Status Badge -->
      <% st = @event.starts_at_local; et = @event.ends_at_local %>
      <% if st.to_date == st.time_zone.today %>
        <% if Time.current.in_time_zone(st.time_zone).between?(st, et) %>
          <div class="position-absolute top-0 end-0 bg-success rounded-pill px-3 py-2 mt-3 me-3 live-badge"
               style="font-size: 0.75rem; font-weight: 600; z-index: 10;">
            <i class="fas fa-bolt me-1"></i>
            NOW
          </div>
        <% else %>
          <div class="position-absolute top-0 end-0 bg-success rounded-pill px-3 py-2 mt-3 me-3 live-badge"
               style="font-size: 0.75rem; font-weight: 600; z-index: 10;">
            <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>
            TODAY
          </div>
        <% end %>
      <% end %>

      <div class="card-body text-center">

        <% if @event.past? %>
          <div class="mb-3 fw-semibold text-danger" style="font-size: 0.9rem;">
            <i class="bi bi-exclamation-circle me-1"></i>
            This event has ended
          </div>
        <% end %>

       <!-- Artists (DB images only) -->
        <% db_artists = @event.all_artists.includes(image_attachment: :blob) %>
        <% manual_names = @event.event_artists.where(artist_id: nil).pluck(:manual_name) %>

        <div class="mb-3 d-flex justify-content-center flex-wrap gap-3">
          <% if db_artists.present? %>
            <% db_artists.each do |a| %>
              <div class="text-center">
                <%= link_to artist_path(a), data: { turbo_frame: "_top" }, class: "d-inline-block" do %>
                  <div class="artist-image-circle">
                    <% if a.image&.attached? %>
                      <%= image_tag a.image.variant(resize_to_fill: [96, 96]).processed,
                            alt: "#{a.username} photo",
                            class: "rounded-circle border border-white border-4",
                            style: "width:96px; height:96px; object-fit:cover; box-shadow:0 8px 20px rgba(13, 110, 253, 0.2);" %>
                    <% else %>
                      <div class="rounded-circle d-flex align-items-center justify-content-center border border-white border-4"
                          style="width:96px; height:96px; color:white; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); box-shadow:0 8px 20px rgba(108, 117, 125, 0.2);">
                        <i class="fas fa-user-music fa-lg"></i>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <!-- No DB artists at all → single generic icon -->
            <div class="artist-image-circle">
              <div class="rounded-circle d-flex align-items-center justify-content-center border border-white border-4"
                  style="width: 96px; height: 96px; color: white; background: linear-gradient(135deg, #6c757d 0%, #495057 100%); box-shadow: 0 8px 20px rgba(108, 117, 125, 0.2);">
                <i class="fas fa-microphone-alt fa-lg"></i>
              </div>
            </div>
          <% end %>
        </div>
        <!-- Date & Time -->
        <div class="d-block">
          <% today_label = (st.to_date == st.time_zone.today) ? "Today" : st.strftime("%A, %b %-d") %>
          <div class="d-inline-block event-time-badge-large text-white mb-4"
               style="font-size: 0.95rem;">
            <i class="bi bi-clock me-1"></i>
            <%= today_label %> •
            <%= st.strftime("%-I:%M %p") %> -
            <%= et.strftime("%-I:%M %p") %>
          </div>
        </div>

        
        <!-- Lineup (links for DB artists, plain text for manual) -->
        <div class="text-center">
          <h5 class="fw-bold mb-2"
              style="background: linear-gradient(90deg, #0d6efd, #4dabf7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            <% lineup_bits = [] %>

            <%# Primary (DB link or manual text) %>
            <% primary_display =
                if @event.artist.present?
                  link_to(@event.artist.username.titleize, artist_path(@event.artist),
                          class: "text-decoration-none", data: { turbo_frame: "_top" })
                else
                  content_tag(:span, @event.artist_name.to_s.titleize, class: "text-muted")
                end %>
            <% lineup_bits << primary_display %>

            <%# Additional DB artists (exclude primary if DB) %>
            <% db_to_show =
                if @event.artist.present?
                  db_artists.reject { |a| a.id == @event.artist_id }
                else
                  db_artists
                end %>
            <% db_to_show.each do |a| %>
              <% lineup_bits << link_to(a.username.titleize, artist_path(a),
                                        class: "text-decoration-none",
                                        data: { turbo_frame: "_top" }) %>
            <% end %>

            <%# Additional manual names %>
            <% manual_names.each do |name| %>
              <% lineup_bits << content_tag(:span, name.to_s.titleize, class: "text-muted") %>
            <% end %>

            <%= safe_join(lineup_bits, " • ".html_safe) %>
          </h5>

          <% if db_artists.blank? && @event.artist.blank? %>
            <p class="text-muted small mb-1">
              This artist isn't on Pickleball, tell them to join!
            </p>
          <% end %>
        </div>

        <div class="mb-1 text-muted small">
          <%= @event.category %>
        </div>

        <!-- Venue Name -->
        <div class="d-inline-block px-3 py-1 rounded-pill bg-light text-dark fw-semibold mb-2"
             style="font-size: 0.9rem;">
          <i class="bi bi-geo-alt me-1"></i>
          <%= link_to "#{@event.venue.name}, #{@event.venue.city}", 
                      venue_path(@event.venue), 
                      class: "text-decoration-none text-dark" %>
        </div>

        <!-- Description -->
        <% if @event.description.present? %>
          <p class="mt-2"><%= simple_format(@event.description) %></p>
        <% end %>
      </div>
    </div>

    <!-- Event Details Card -->
    <div class="card border-0 event-details-card mb-4">
      <div class="card-body">
        <h5 class="text-center section-title" style="color: #6c757d; font-weight: 600; font-size: 1.1rem; margin-bottom: 1.5rem;">Event Details</h5>
        <!-- Indoor/Outdoor -->
        <div class="text-center detail-box mb-3">
          <i class="bi bi-<%= @event.indoors? ? 'house-door' : 'sun' %> fs-2 mb-2 d-block"
             style="color: <%= @event.indoors? ? '#2ed573' : '#ffa502' %>;"></i>
          <div class="fw-semibold text-dark">
            <%= @event.indoors? ? "Indoor Event" : "Outdoor Event" %>
          </div>
        </div>

        <!-- Cover Charge -->
        <% if @event.cover? %>
          <div class="text-center detail-box mb-3">
            <i class="bi bi-cash fs-2 mb-2 d-block" style="color: #2ed573;"></i>
            <div class="fw-semibold text-dark">
              Cover: <%= number_to_currency(@event.cover_amount) %>
            </div>
          </div>
        <% end %>

        <!-- Map Section -->
        <% if @event.venue.latitude.present? && @event.venue.longitude.present? %>
          <div class="text-center detail-box">
            <i class="bi bi-geo-alt fs-2 mb-3 d-block" style="color: #0d6efd;"></i>

            <% maps_url =
              if hotwire_native_app?
                "/events/map?lat=#{@event.venue.latitude}&lng=#{@event.venue.longitude}&venue_id=#{@event.venue.id}"
              else
                "https://www.google.com/maps/search/#{CGI.escape(@event.venue.name)}/@#{@event.venue.latitude},#{@event.venue.longitude},17z"
              end %>

          <%= link_to maps_url,
                      class: "btn map-btn-modern text-white",
                      target: (hotwire_native_app? ? nil : "_blank"),
                      rel: (hotwire_native_app? ? nil : "noopener noreferrer"),
                      data: (hotwire_native_app? ? { turbo_frame: "_top" } : {}) do %>
            <i class="bi bi-map me-2"></i>Show on Map
          <% end %>


          </div>
        <% end %>
      </div>
    </div>

    <!-- Admin Actions (if applicable) -->
    <% if can_modify_event?(@event) && !@event.past? %>
      <div class="card border-0 event-details-card mb-4">
        <div class="card-body">
          <h5 class="text-center section-title" style="color: #6c757d; font-weight: 600; font-size: 1.1rem; margin-bottom: 1.5rem;">Event Management</h5>
          <div class="row g-3 justify-content-center">
            <div class="col-auto">
              <%= link_to edit_event_path(@event), 
                      class: "btn btn-warning rounded-pill px-4 py-2 fw-semibold",
                      style: "box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);" do %>
                <i class="bi bi-pencil me-2"></i>Edit Event
              <% end %>
            </div>

            <div class="col-auto">
              <%= button_to event_path(@event), 
                        method: :delete, 
                        class: "btn btn-danger rounded-pill px-4 py-2 fw-semibold",
                        style: "box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);",
                        data: { confirm: "Are you sure you want to cancel this event? It will cancel for all artists at this event and this action cannot be undone." } do %>
                <i class="bi bi-trash me-2"></i>Cancel Event
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

  </div>
</div>
