<!-- Owner Edit Event Form -->
<div class="container pt-4" style="max-width: 600px;">
  <h2 class="mb-4 text-center">Edit Event</h2>

  <%= form_with model: event, local: true, class: "needs-validation",
        data: {
          controller: "time-options owner-category-warning conflict-checker",
          conflict_checker_endpoint_value: "/events/conflicts_ajax"
        } do |f| %>


    <!-- Venue (display) -->
    <div class="mb-3">
      <label class="form-label fw-bold">Venue</label>
      <p class="form-control-plaintext text-muted"><%= event.venue.name %></p>
      <%= hidden_field_tag "event[venue_slug]", event.venue.slug,
            data: {
              time_options_target: "venue",
              conflict_checker_target: "venue",
              action: "change->conflict-checker#venueChanged"
            } %>
    </div>

<!-- Primary Artist (editable) -->
<div class="mb-3" data-controller="owner-artist-autocomplete">
  <label class="form-label fw-bold">Artist</label>

  <div class="position-relative">
    <input type="text"
           class="form-control pe-5"
           placeholder="Search artist..."
           value="<%= event.artist&.username %>"
           data-owner-artist-autocomplete-target="input"
           data-action="input->owner-artist-autocomplete#search" 
           autocomplete="off" autocorrect="off" autocapitalize="none"
           spellcheck="false" inputmode="search" />

    <button type="button"
            class="btn btn-sm position-absolute top-50 translate-middle-y end-0 me-2 text-muted"
            aria-label="Clear artist"
            data-owner-artist-autocomplete-target="clearButton"
            data-action="owner-artist-autocomplete#clearSearch">
      &times;
    </button>

    <ul class="list-group small mt-2 position-absolute w-100"
        data-owner-artist-autocomplete-target="results"
        style="top:100%;left:0;max-height:240px;overflow-y:auto;z-index:1000;border-radius:.5rem;"></ul>
  </div>

  <!-- Persist the selected DB artist id (if any) -->
  <input type="hidden" name="event[artist_id]"
         value="<%= event.artist_id %>"
         data-owner-artist-autocomplete-target="hidden" />

  <!-- Picked-artist verification (shown when a DB artist is selected) -->
  <div class="border border-info rounded p-3 bg-info-subtle mt-3 <%= event.artist_id.present? ? '' : 'd-none' %>"
       data-owner-artist-autocomplete-target="details">
    <h5>Does this look right?</h5>

    <div class="d-flex align-items-start gap-3">
      <div class="flex-shrink-0" data-owner-artist-autocomplete-target="imageContainer">
        <% if event.artist&.image&.attached? %>
          <%= image_tag event.artist.image.variant(resize_to_fill: [80,80]).processed,
                        class: "rounded-circle",
                        style: "width:80px;height:80px;object-fit:cover;" %>
        <% end %>
      </div>
      <div class="flex-grow-1">
        <p class="mb-1"><strong>Username:</strong>
          <span data-owner-artist-autocomplete-target="username"><%= event.artist&.username %></span>
        </p>
        <p class="mb-0 text-muted small" data-owner-artist-autocomplete-target="bio"><%= event.artist&.bio %></p>
      </div>
    </div>

    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" id="artist_verification"
             name="artist_verification" value="1"
             <%= 'checked' if event.artist_id.present? %>
             data-owner-artist-autocomplete-target="verification"
             data-action="change->owner-artist-autocomplete#toggleSubmit change->conflict-checker#endTimeChanged">
      <label class="form-check-label" for="artist_verification">
        <strong>Yes, this is the correct artist for my event</strong>
      </label>
    </div>
  </div>

  <!-- Manual gate (lets you switch to manual) -->
  <div class="form-check mt-3">
    <input class="form-check-input" type="checkbox" id="artist_gate_checkbox"
           <%= 'checked' if event.artist_id.blank? && event.artist_name.present? %>
           data-owner-artist-autocomplete-target="gateCheckbox"
           data-action="change->owner-artist-autocomplete#toggleGate change->conflict-checker#endTimeChanged">
    <label class="form-check-label" for="artist_gate_checkbox">
      I can't find the artist
    </label>
  </div>

  <!-- Manual artist name -->
  <div class="mt-2 <%= (event.artist_id.blank? && event.artist_name.present?) ? '' : 'd-none' %>"
       data-owner-artist-autocomplete-target="manualFieldsWrapper">
    <label class="form-label">Artist Name</label>
    <input type="text" id="manual_artist_name"
           name="event[artist_name]"
           value="<%= event.artist_id.present? ? '' : event.artist_name %>"
           class="form-control"
           data-owner-artist-autocomplete-target="manualNameField"
           data-action="input->owner-artist-autocomplete#manualNameChanged input->conflict-checker#endTimeChanged">
  </div>
</div>


    <!-- Additional Artists (Owner Edit) -->
<div class="mb-3" data-controller="owner-multi-artists" data-multi-artists-max-value="5" data-owner-multi-artists-primary-present-value="true">
  <div class="form-check mb-2">
    <% expanded = event.event_artists.any? %>
    <input class="form-check-input" type="checkbox" id="owner_edit_addl_toggle"
           data-action="owner-multi-artists#toggle"
           data-owner-multi-artists-target="toggle"
           <%= "checked" if expanded %>>
    <label class="form-check-label" for="owner_edit_addl_toggle">
      Additional artists at this show
    </label>
  </div>

  <div class="<%= expanded ? '' : 'd-none' %> border rounded p-3 bg-light" data-owner-multi-artists-target="container">
    <div data-owner-multi-artists-target="rows">
      <% event.event_artists.each_with_index do |ea, idx| %>
        <div class="border rounded p-2 mb-2 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Artist <%= idx + 2 %></strong>
              <button type="button" class="btn btn-sm btn-link text-danger"
                      data-action="owner-multi-artists#removeRow">Remove</button>
            </div>

            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox"
                    <%= 'checked' if ea.artist_id.blank? %>
                    data-action="owner-multi-artists#toggleManual" />
              <label class="form-check-label">Artist not on Pickleball</label>
            </div>

          <!-- DB pick -->
          <div class="mb-2 <%= ea.artist_id.present? ? '' : 'd-none' %>" data-db-wrapper>
            <div class="position-relative" data-controller="inline-artist-autocomplete">
              <input type="text" class="form-control pe-5"
                    placeholder="Search artist..."
                    value="<%= ea.artist_id.present? ? ea.artist.username : '' %>"
                    data-inline-artist-autocomplete-target="input" autocomplete="off" />
              <ul class="list-group small mt-1 position-absolute w-100"
                  data-inline-artist-autocomplete-target="results"
                  style="z-index:1000; max-height:200px; overflow:auto;"></ul>

              <input type="hidden" name="event[additional_artist_ids][]"
                    value="<%= ea.artist_id %>"
                    data-inline-artist-autocomplete-target="hidden" />

              <div class="border border-info rounded p-2 bg-info-subtle mt-2 <%= ea.artist_id.present? ? '' : 'd-none' %>"
                  data-inline-artist-autocomplete-target="details">
                <div class="d-flex align-items-start gap-2">
                  <div class="flex-shrink-0" data-inline-artist-autocomplete-target="imageContainer">
                    <% if ea.artist_id.present? && ea.artist.image.attached? %>
                      <%= image_tag ea.artist.image.variant(resize_to_fill: [80, 80]).processed,
                                    class: "rounded-circle",
                                    style: "width:80px;height:80px;object-fit:cover;" %>
                    <% end %>
                  </div>
                  <div class="flex-grow-1">
                    <p class="mb-1"><strong>Username:</strong>
                      <span data-inline-artist-autocomplete-target="username"><%= ea.artist_id.present? ? ea.artist.username : "" %></span>
                    </p>
                    <p class="mb-0 text-muted small" data-inline-artist-autocomplete-target="bio"><%= ea.artist_id.present? ? ea.artist.bio : "" %></p>
                  </div>
                </div>

                <div class="form-check mt-2">
                  <input type="hidden" name="event[additional_artist_verified][]" value="<%= ea.artist_id.present? ? '1' : '0' %>"
                        data-inline-artist-autocomplete-target="verifiedField">
                  <input class="form-check-input" type="checkbox"
                        <%= 'checked' if ea.artist_id.present? %>
                        data-inline-artist-autocomplete-target="verification">
                  <label class="form-check-label">
                    <strong>Yes, this is the correct artist for my event</strong>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Manual entry -->
          <div class="mb-2 <%= ea.artist_id.present? ? 'd-none' : '' %>" data-manual-wrapper>
            <input type="text" class="form-control"
                  name="event[additional_manual_names][]"
                  value="<%= ea.artist_id.present? ? '' : ea.manual_name %>"
                  placeholder="Enter artist name" />
          </div>
        </div>
      <% end %>
    </div>

    <div class="d-flex justify-content-between mt-2">
      <button type="button" class="btn btn-outline-secondary btn-sm"
              data-action="owner-multi-artists#addRow">Add another artist</button>
      <span class="text-muted small">(max 5)</span>
    </div>
  </div>
</div>



    <!-- Category -->
    <div class="mb-3">
      <%= f.label :category, class: "form-label" %>
      <%= f.select :category,
            Artist::PERFORMANCE_TYPES.map { |type| [type, type] },
            { prompt: "Select category" },
            {
              class: "form-select",
              required: true,
              data: {
                owner_category_warning_target: "category",
                action: "change->owner-category-warning#checkCategory"
              }
            } %>
      <div class="small text-muted mt-1 d-none" data-owner-category-warning-target="warning"></div>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <%= f.label :description, class: "form-label fw-bold" %>
      <%= f.text_area :description,
            class: "form-control",
            placeholder: "Describe the event",
            rows: 3 %>
    </div>

    <!-- Date -->
    <div class="mb-3">
      <%= f.label :date, class: "form-label fw-bold" %>
      <%= f.select :date, [["Select date", ""]], {},
          class: "form-select", required: true,
          data: {
            time_options_target: "date",
            conflict_checker_target: "date",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.to_date&.to_s),
            action: "change->time-options#updateStartTimes change->conflict-checker#dateChanged"
          } %>
    </div>

    <!-- Start Time -->
    <div class="mb-3">
      <%= f.label :start_time, "Start Time", class: "form-label fw-bold" %>
      <%= f.select :start_time, [["Select start time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "startTime",
            conflict_checker_target: "startTime",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->time-options#updateEndTimes change->conflict-checker#startTimeChanged"
          } %>
    </div>

    <!-- End Time -->
    <div class="mb-3">
      <%= f.label :end_time, "End Time", class: "form-label fw-bold" %>
      <%= f.select :end_time, [["Select end time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "endTime",
            conflict_checker_target: "endTime",
            default_value: (event.end_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->conflict-checker#endTimeChanged"
          } %>
    </div>

    <!-- Conflict banner -->
    <div class="mb-2" data-conflict-checker-target="flash"></div>

    <!-- Remove the entire Cover UI block and replace with: -->
      <%= f.hidden_field :cover, value: "0" %>
      <%= f.hidden_field :cover_amount, value: nil %>

    <!-- Outdoors -->
    <div class="form-check mb-4">
      <%= f.check_box :indoors,
            { checked: event.outdoors?, class: "form-check-input" },
            "0",
            "1" %>
      <%= f.label :indoors, "Outdoors?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Exclude self -->
    <input type="hidden" value="<%= event.id %>" data-conflict-checker-target="excludeId">

    <div class="d-grid">
      <%= f.submit "Update Event",
            class: "btn btn-primary",
            data: { conflict_checker_target: "submit" } %>
    </div>

    <div class="small mt-2 d-none">
      <div data-submit-help-global class="text-danger"></div>
    </div>

  <% end %>
</div>
