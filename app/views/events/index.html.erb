<% content_for :title, "Upcoming Events Near You" %>

<style>
  .search-card {
    border-radius: 24px;
    background: white;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    transition: all 0.3s ease;
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .search-toggle-btn {
    font-weight: 600;
    color: #0d6efd;
    transition: all 0.3s ease;
  }

  .search-toggle-btn:hover {
    color: #0056b3;
  }

  .search-btn-modern {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    border: none;
    padding: 0.75rem;
    border-radius: 25px;
    font-weight: 600;
    box-shadow: 0 6px 15px rgba(13, 110, 253, 0.3);
    transition: all 0.3s ease;
  }

  .search-btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(13, 110, 253, 0.4);
  }

  .form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  .back-to-top-modern {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    border: none;
    box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
    font-size: 1.25rem;
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .back-to-top-modern:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(13, 110, 253, 0.5);
  }

  .summary-card {
    border-radius: 16px;
    background: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  }

  .empty-state {
    padding: 4rem 2rem;
    text-align: center;
    color: #6c757d;
  }
</style>

<div class="min-vh-100 bg-light">
  <div class="container py-4" style="max-width: 600px;">

    <!-- Collapsible Search Section -->
    <div class="card border-0 search-card overflow-hidden mb-4">
      <div class="card-header bg-white border-0 p-3">
        <button class="btn btn-link search-toggle-btn text-decoration-none p-0 w-100 text-center d-flex justify-content-center align-items-center"
                type="button"
                onclick="toggleSearchForm()"
                id="searchToggleBtn">
          <span class="fw-semibold">üîç Search & Filter Events</span>
          <span class="position-absolute end-0 me-3" id="chevronIcon" style="color: #0d6efd;">‚ñº</span>
        </button>
      </div>

      <div class="collapse" id="searchForm" style="display: none;">
        <div class="card-body p-4 pt-0 text-start">

          <%= form_with url: events_path, method: :get, local: false,
                        data: {
                          controller: "location-search",
                          "location-search-current-lat-value": params[:lat],
                          "location-search-current-lng-value": params[:lng],
                          "location-search-current-address-value": params[:address],
                          "location-search-current-radius-value": params[:radius] || 5,
                          turbo_frame: "events-container"
                        } do |f| %>

            <!-- Location -->
            <div class="mb-3">
              <label class="form-label small text-muted">Location</label>

              <div class="form-check mb-2">
                <%= radio_button_tag :location_type, "address", true,
                      class: "form-check-input",
                      data: { "location-search-target": "addressRadio" } %>
                <%= label_tag :location_type_address, "Enter address", class: "form-check-label" %>
              </div>

              <%= f.text_field :address,
                    placeholder: "Enter address or ZIP code",
                    class: "form-control",
                    value: params[:address],
                    data: { "location-search-target": "addressInput" } %>

              <div class="form-check mt-2">
                <%= radio_button_tag :location_type, "current", false,
                      class: "form-check-input",
                      data: { "location-search-target": "currentRadio", action: "change->location-search#getCurrentLocation" } %>
                <%= label_tag :location_type_current, "Use my current location", class: "form-check-label" %>
              </div>
            </div>

            <!-- Radius -->
            <div class="mb-3">
              <%= f.label :radius, "Search Radius", class: "form-label small text-muted" %>
              <%= f.select :radius,
                    options_for_select([
                      ['1 mi', 1], ['5 mi', 5], ['10 mi', 10], ['25 mi', 25]
                      #['15 mi', 15], ['25 mi', 25], ['50 mi', 50]
                    ], params[:radius] || 1),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Date Range -->
            <div class="mb-3">
              <%= f.label :date_range, "Show events for", class: "form-label small text-muted" %>
              <%= f.select :date_range,
                    options_for_select([
                      ["Any Date", ""],
                      ["Today", "today"],
                      ["Next 7 Days", "next_7_days"]
                    ], params[:date_range]),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Sort By -->
            <div class="mb-3">
              <%= f.label :sort_by, "Sort by", class: "form-label small text-muted" %>
              <%= f.select :sort_by,
                    options_for_select([
                      ["Soonest First", "date"],
                      ["Closest First", "distance"]
                    ], params[:sort_by] || "date"),
                    {},
                    class: "form-select",
                    data: {
                      action: (params[:address].present? || params[:lat].present?) ? "change->location-search#autoSubmit" : ""
                    } %>
            </div>

            <!-- Error message -->
            <div id="location-error" class="alert alert-danger d-none mb-3" role="alert">
              Please enter an address or use your current location before searching.
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn search-btn-modern text-white w-100">
              Search Events
            </button>

            <%= f.hidden_field :lat, data: { "location-search-target": "latInput" } %>
            <%= f.hidden_field :lng, data: { "location-search-target": "lngInput" } %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Search Summary -->
    <%= turbo_frame_tag "events-container" do %>
      <% if params[:address].present? || params[:lat].present? || params[:date_range].present? %>
        <div class="card summary-card mb-3 border-0 text-center">
          <div class="card-body py-2">
            <small style="color: #6c757d;">
              <% if params[:address].present? %>
                Found  <% if @events.respond_to?(:count) %>
                  <%= pluralize(@events.count, 'event') %> within
                  <%= params[:radius] || 5 %> miles of "<%= params[:address] %>"

                <% elsif params[:lat].present? %>
                  Found <% if @events.respond_to?(:count) %>
                    <%= pluralize(@events.count, 'event') %> within
                    <%= params[:radius] || 5 %> miles of your location
                  <% end %>
                <% end %>

              <% end %>
            </small>
          </div>
        </div>
      <% end %>

      <!-- Events List or Empty State -->
      <% if @events&.any? %>
        <%= render partial: "events", collection: @events %>
      <% else %>
        <div class="empty-state">
          <i class="bi bi-calendar-x" style="font-size: 4rem; color: #adb5bd;"></i>
          <h5 class="mt-4 fw-semibold" style="color: #495057;">No events found</h5>
          <p style="color: #6c757d;">
            <% if params[:address].present? || params[:lat].present? || params[:date_range].present? %>
              Try expanding your search radius, location, or date range.
            <% else %>
              Check back soon for upcoming events!
            <% end %>
          </p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<!-- Back to top button -->
<button id="backToTop" onclick="scrollToTop()" class="back-to-top-modern">
  ‚Üë
</button>

<script>
  function toggleSearchForm() {
    const form    = document.getElementById('searchForm');
    const chevron = document.getElementById('chevronIcon');
    const isOpen  = form.style.display === 'block';
    form.style.display = isOpen ? 'none' : 'block';
    chevron.textContent = isOpen ? '‚ñº' : '‚ñ≤';
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.addEventListener("scroll", function () {
    const btn = document.getElementById("backToTop");
    btn.style.display = window.scrollY > 300 ? "flex" : "none";
  });
</script>
