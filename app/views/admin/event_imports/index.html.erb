<h1>Event Imports</h1>

<!-- City picker (GET) so we can show venues without creating a batch yet -->
<%= form_with url: admin_event_imports_path, method: :get, local: true, data: { controller: "submit-on-change" } do %>
  <div>
    <label for="city">City</label>
    <select name="city" id="city" required data-action="change->submit-on-change#submit">
      <option value="">Select a city…</option>
      <% @cities.each do |c| %>
        <option value="<%= c %>" <%= "selected" if c == @city %>><%= c %></option>
      <% end %>
    </select>
  </div>
<% end %>

<!-- When a city is selected, render venue selection + run button -->
<% if @city.present? %>
  <hr class="my-4">

  <h2>Venues in <%= @city %></h2>

  <% if @venues.blank? %>
    <p>No venues with websites in this city.</p>
  <% else %>
    <div class="mb-2">
      <button type="button" data-action="click->venue-select#all">Select all</button>
      <button type="button" data-action="click->venue-select#none">Select none</button>
    </div>

    <%= form_with url: admin_event_imports_path, method: :post, local: true, data: { controller: "venue-select" } do %>
      <input type="hidden" name="city" value="<%= @city %>">

      <ul style="columns: 2; gap: 2rem; list-style: none; padding: 0;">
        <% @venues.each do |v| %>
          <li>
            <label>
              <input type="checkbox"
                     name="venue_ids[]"
                     value="<%= v.id %>"
                     data-venue-select-target="box">
              <strong><%= v.name %></strong>
              <% if v.website.present? %>
                — <a href="<%= v.website %>" target="_blank" rel="noopener">site</a>
              <% end %>
            </label>
          </li>
        <% end %>
      </ul>

      <div class="mt-2">
        <label style="display: block; margin-bottom: 0.5rem;">
          <input type="checkbox" name="use_browser" value="true">
          Use browser mode (Selenium) - slower but works with JavaScript-rendered pages
        </label>

        <button type="submit">Run import for <%= @city %></button>
      </div>
    <% end %>
  <% end %>
<% end %>

<% if notice.present? %>
  <p class="mt-4"><%= notice %></p>
<% end %>

<% if @latest_batch.present? %>
  <p class="mt-4">
    Latest batch:
    <%= link_to "Batch ##{@latest_batch.id} (#{@latest_batch.city}) - #{@latest_batch.status}",
                admin_event_import_path(@latest_batch) %>
  </p>
<% end %>
