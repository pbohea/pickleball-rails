<div class="card mt-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Request New Venue</h5>
  </div>

  <div
    class="card-body"
    data-controller="venue-autocomplete-with-manual"
    data-venue-autocomplete-with-manual-owner-value="<%= owner_signed_in? %>"
    data-venue-autocomplete-with-manual-claim-url-value="<%= claim_venue_requests_path %>"
  >
    <%= form_with model: @venue_request,
              url: venue_requests_path,
              local: true,
              multipart: true,
              data: { controller: "safe-submit" } do |f| %>

      <% if @venue_request.errors.any? %>
        <div class="alert alert-danger mb-3">
          <h6>Please fix the following errors:</h6>
          <ul class="mb-0">
            <% @venue_request.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Hidden: stores slug when a venue is selected from search -->
      <%= hidden_field_tag :selected_venue_slug, "",
            data: { venue_autocomplete_with_manual_target: "hidden" } %>

      <!-- Venue Search (with inline clear × button like your other form) -->
      <div class="mb-3">
        <label class="form-label">Check if this venue already exists</label>

        <div class="position-relative">
          <input type="text"
                 class="form-control pe-5"
                 placeholder="Search venues..."
                 data-venue-autocomplete-with-manual-target="input"
                 data-action="input->venue-autocomplete-with-manual#search">

          <button type="button"
                  class="btn btn-sm position-absolute top-50 translate-middle-y end-0 me-2 text-muted"
                  style="z-index: 10;"
                  aria-label="Clear venue search"
                  data-venue-autocomplete-with-manual-target="clearButton"
                  data-action="venue-autocomplete-with-manual#clearSearch">
            &times;
          </button>
        </div>

        <ul class="list-group mt-2"
            data-venue-autocomplete-with-manual-target="results"
            style="border-radius: 0.5rem;"></ul>

        <small class="form-text text-muted">Search first to see if this venue is already in our database.</small>
      </div>

      <!-- Always-visible confirmation checkbox that gates the rest of the form -->
      <div class="form-check mb-3">
        <input class="form-check-input"
               type="checkbox"
               id="venue_gate_checkbox"
               data-venue-autocomplete-with-manual-target="gateCheckbox"
               data-action="change->venue-autocomplete-with-manual#toggleGate">
        <label class="form-check-label" for="venue_gate_checkbox">
          This venue isn't on Pickleball yet.
        </label>
      </div>

      <!-- Result info / decision panel (for artists) -->
      <div class="border rounded p-3 mb-3 d-none"
           data-venue-autocomplete-with-manual-target="details">
        <h6 class="mb-2">Is this the venue you're trying to add?</h6>
        <div class="small text-muted mb-2">
          <div><strong>Name:</strong> <span data-venue-autocomplete-with-manual-target="name"></span></div>
          <div><strong>Address:</strong> <span data-venue-autocomplete-with-manual-target="address"></span></div>
          <div class="d-none" data-venue-autocomplete-with-manual-target="websiteWrap">
            <strong>Website:</strong>
            <a href="#" target="_blank" rel="noopener"
               data-venue-autocomplete-with-manual-target="website"></a>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button"
                  class="btn btn-sm btn-primary"
                  data-action="click->venue-autocomplete-with-manual#confirmSelectedVenue">
            Yes
          </button>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary"
                  data-action="click->venue-autocomplete-with-manual#rejectSelectedVenue">
            No, this isn’t the right venue
          </button>
        </div>
      </div>

      <!-- The rest of the form is gated by the checkbox above -->
      <div class="mt-2 d-none" data-venue-autocomplete-with-manual-target="manualFieldsWrapper">
        <div class="mb-3">
          <%= f.label :name, "Venue Name", class: "form-label" %>
          <%= f.text_field :name, class: "form-control", required: true %>
        </div>

        <div class="mb-3">
          <%= f.label :street_address, "Street Address", class: "form-label" %>
          <%= f.text_field :street_address, class: "form-control", required: true %>
        </div>

        <div class="mb-3">
          <%= f.label :city, "City", class: "form-label" %>
          <%= f.text_field :city, class: "form-control", required: true %>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <%= f.label :state, "State", class: "form-label" %>
            <%= f.select :state, options_for_select([
              ['Alabama', 'AL'], ['Alaska', 'AK'], ['Arizona', 'AZ'], ['Arkansas', 'AR'],
              ['California', 'CA'], ['Colorado', 'CO'], ['Connecticut', 'CT'], ['Delaware', 'DE'],
              ['Florida', 'FL'], ['Georgia', 'GA'], ['Hawaii', 'HI'], ['Idaho', 'ID'],
              ['Illinois', 'IL'], ['Indiana', 'IN'], ['Iowa', 'IA'], ['Kansas', 'KS'],
              ['Kentucky', 'KY'], ['Louisiana', 'LA'], ['Maine', 'ME'], ['Maryland', 'MD'],
              ['Massachusetts', 'MA'], ['Michigan', 'MI'], ['Minnesota', 'MN'], ['Mississippi', 'MS'],
              ['Missouri', 'MO'], ['Montana', 'MT'], ['Nebraska', 'NE'], ['Nevada', 'NV'],
              ['New Hampshire', 'NH'], ['New Jersey', 'NJ'], ['New Mexico', 'NM'], ['New York', 'NY'],
              ['North Carolina', 'NC'], ['North Dakota', 'ND'], ['Ohio', 'OH'], ['Oklahoma', 'OK'],
              ['Oregon', 'OR'], ['Pennsylvania', 'PA'], ['Rhode Island', 'RI'], ['South Carolina', 'SC'],
              ['South Dakota', 'SD'], ['Tennessee', 'TN'], ['Texas', 'TX'], ['Utah', 'UT'],
              ['Vermont', 'VT'], ['Virginia', 'VA'], ['Washington', 'WA'], ['West Virginia', 'WV'],
              ['Wisconsin', 'WI'], ['Wyoming', 'WY'],
              ['District of Columbia', 'DC'], ['Puerto Rico', 'PR'], ['Guam', 'GU'],
              ['American Samoa', 'AS'], ['U.S. Virgin Islands', 'VI'], ['Northern Mariana Islands', 'MP']
            ]), { prompt: 'Select State or Territory' }, { class: "form-select", required: true } %>
          </div>
          <div class="col-md-6">
            <%= f.label :zip_code, "ZIP Code", class: "form-label" %>
            <%= f.text_field :zip_code, class: "form-control", required: true %>
          </div>
        </div>

        <div class="mb-3">
          <%= f.label :category, "Venue Type", class: "form-label" %>
          <%= f.select :category, options_for_select(
            Venue::CATEGORIES.map { |category| [category, category] }
          ), { prompt: 'Select type' }, { class: "form-select", required: true } %>
        </div>

        <div class="mb-3">
          <%= f.label :website, "Website (optional)", class: "form-label" %>
          <%= f.text_field :website, class: "form-control", placeholder: "https://example.com" %>
        </div>

        <% if owner_signed_in? %>
          <div class="mb-3 p-3 bg-light border-start border-primary border-4">
            <p class="mb-0 text-muted">
              <i class="fas fa-info-circle me-2"></i>
              Since you're signed in as an owner, this will also request ownership of the venue.
            </p>
          </div>

          <div class="mb-3">
            <%= f.label :utility_bill, "Upload a utility bill, liquor license, lease, deed, or other document to prove ownership. Redact any sensitive information. We will discard this file once your request is approved.", class: "form-label" %>
            <%= f.file_field :utility_bill, class: "form-control", required: true %>
          </div>
        <% end %>
      </div>

      <div class="d-grid">
        <% if owner_signed_in? %>
          <%= f.submit "Request Venue & Claim Ownership",
                 class: "btn btn-success",
                 data: { venue_autocomplete_with_manual_target: "submitButton",
                         safe_submit_target: "button" },
                 disabled: true %>
        <% else %>
          <%= f.submit "Request Venue",
                 class: "btn btn-success",
                 data: { venue_autocomplete_with_manual_target: "submitButton",
                         safe_submit_target: "button" },
                 disabled: true %>
        <% end %>
      </div>

    <% end %>
  </div>
</div>
