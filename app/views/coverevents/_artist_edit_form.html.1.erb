<!-- FORM 3: Edit Event Form -->
<div class="container pt-4" style="max-width: 600px;">
  <h2 class="mb-4 text-center">Edit Event</h2>

  <%= form_with model: event, local: true, class: "needs-validation",
      data: {
        controller: "time-options artist-category-warning conflict-checker",
        conflict_checker_endpoint_value: "/events/conflicts_ajax",
        artist_category_warning_artist_performance_type_value: (event.artist&.performance_type || ""),
        artist_category_warning_is_edit_value: "true"
      } do |f| %>

    <!-- Display current artist and venue (non-editable) -->
    <div class="mb-3">
      <label class="form-label fw-bold">Artist</label>
      <p class="form-control-plaintext text-muted">
        <% if event.artist.present? %>
          <%= event.artist.username %>
        <% else %>
          <%= event.artist_name %>
        <% end %>
      </p>
    </div>

    <div class="mb-3">
      <label class="form-label fw-bold">Venue</label>
      <p class="form-control-plaintext text-muted"><%= event.venue.name %></p>
      <!-- Hidden venue slug so JS can fetch date/time options -->
      <%= hidden_field_tag "event[venue_slug]", event.venue.slug,
            data: {
              time_options_target: "venue",
              conflict_checker_target: "venue",
              action: "change->conflict-checker#venueChanged"
            } %>
    </div>

    <!-- Category Dropdown -->
    <div class="mb-3">
      <%= f.label :category, class: "form-label" %>
      <%= f.select :category,
            Artist::PERFORMANCE_TYPES.map { |type| [type, type] },
            { selected: event.category },
            {
              class: "form-select",
              required: true,
              data: {
                artist_category_warning_target: "category",
                action: "change->artist-category-warning#checkCategory"
              }
            } %>
      <div class="small text-muted mt-1 d-none" data-artist-category-warning-target="warning">
        This differs from your profile and will only apply to this event
      </div>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <%= f.label :description, class: "form-label fw-bold" %>
      <%= f.text_area :description,
            class: "form-control",
            placeholder: "Describe the event",
            rows: 3 %>
    </div>

    <!-- Date Dropdown -->
    <div class="mb-3">
      <%= f.label :date, class: "form-label fw-bold" %>
      <%= f.select :date, [["Select date", ""]], {},
          class: "form-select", required: true,
          data: {
            time_options_target: "date",
            conflict_checker_target: "date",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.to_date&.to_s),
            action: "change->time-options#updateStartTimes change->conflict-checker#dateChanged"
          } %>
    </div>

    <!-- Start Time Dropdown -->
    <div class="mb-3">
      <%= f.label :start_time, "Start Time", class: "form-label fw-bold" %>
      <%= f.select :start_time, [["Select start time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "startTime",
            conflict_checker_target: "startTime",
            default_value: (event.start_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->time-options#updateEndTimes change->conflict-checker#startTimeChanged"
          } %>
    </div>

    <!-- End Time Dropdown -->
    <div class="mb-3">
      <%= f.label :end_time, "End Time", class: "form-label fw-bold" %>
      <%= f.select :end_time, [["Select end time", ""]], {}, 
          class: "form-select", required: true,
          data: {
            time_options_target: "endTime",
            conflict_checker_target: "endTime",
            default_value: (event.end_time&.in_time_zone(event.venue.tz_name)&.strftime("%H:%M")),
            action: "change->conflict-checker#endTimeChanged"
          } %>
    </div>

    <!-- Live conflict banner -->
    <div class="mb-2" data-conflict-checker-target="flash"></div>

    <!-- Cover Checkbox -->
    <div class="form-check mb-3">
      <%= f.check_box :cover,
            class: "form-check-input",
            id: "event_cover",
            onchange: "toggleCoverAmount()" %>
      <%= f.label :cover, "Cover Charge?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Cover Amount Field -->
    <div class="mb-3" id="cover-amount-field" style="display: <%= event.cover? ? 'block' : 'none' %>;">
      <%= f.label :cover_amount, "Cover Amount ($)", class: "form-label fw-bold" %>
      <%= f.number_field :cover_amount,
            class: "form-control",
            placeholder: "Enter amount",
            min: 1,
            step: 1 %>
    </div>

    <!-- Outdoors Checkbox -->
    <div class="form-check mb-4">
      <%= f.check_box :indoors,
            { checked: event.outdoors?, class: "form-check-input" },
            "0",
            "1" %>
      <%= f.label :indoors, "Outdoors?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Exclude self from conflict check -->
    <input type="hidden" value="<%= event.id %>" data-conflict-checker-target="excludeId">

    <div class="d-grid">
      <%= f.submit "Update Event",
            class: "btn btn-primary",
            data: { conflict_checker_target: "submit" } %>
    </div>

  <% end %>
</div>
