<!-- Admin Edit Event Form -->
<div class="container pt-4" style="max-width: 600px;">
  <h2 class="mb-4 text-center">Edit Event (Admin)</h2>

  <%= form_with model: @event, local: true, class: "needs-validation",
              data: { 
                controller: "time-options owner-category-warning",
                owner_category_warning_is_edit_value: "true"
              } do |f| %>

    <!-- Artist Selection (Editable for Admin) -->
    <div class="mb-3" data-controller="owner-artist-autocomplete">
      <%= label_tag "artist_search", "Search for Artist", class: "form-label fw-bold" %>
      
      <div class="position-relative">
        <%= text_field_tag "artist_search", 
              (@event.artist.present? ? @event.artist.username : @event.artist_name),
              placeholder: "Start typing...",
              class: "form-control pe-5",
              data: {
                action: "input->owner-artist-autocomplete#search",
                owner_artist_autocomplete_target: "input"
              },
              autocomplete: "off", autocorrect: "off", autocapitalize: "none",
              spellcheck: "false", inputmode: "search" %>

        <button type="button"
                class="btn btn-sm position-absolute top-50 translate-middle-y end-0 me-2 text-muted"
                style="z-index: 10;"
                aria-label="Clear artist"
                data-owner-artist-autocomplete-target="clearButton"
                data-action="owner-artist-autocomplete#clearSearch">
          &times;
        </button>

        <ul class="list-group small mt-2 position-absolute w-100"
            data-owner-artist-autocomplete-target="results"
            style="top: 100%; left: 0; max-height: 240px; overflow-y: auto; -webkit-overflow-scrolling: touch; border-radius: .5rem; z-index: 1000;"></ul>
      </div>

      <%= hidden_field_tag "event[artist_id]", @event.artist_id,
            data: { owner_artist_autocomplete_target: "hidden" } %>

      <!-- Artist verification section -->
      <div class="border border-info rounded p-3 bg-info-subtle mt-3 d-none"
           data-owner-artist-autocomplete-target="details">
        <h5>Does this look right?</h5>

        <div class="d-flex align-items-start gap-3">
          <div class="flex-shrink-0" data-owner-artist-autocomplete-target="imageContainer"></div>
          <div class="flex-grow-1">
            <p class="mb-1"><strong>Username:</strong>
              <span data-owner-artist-autocomplete-target="username"></span>
            </p>
            <p class="mb-2"><strong>Bio:</strong></p>
            <p class="text-muted small mb-0" data-owner-artist-autocomplete-target="bio"></p>
          </div>
        </div>

        <div class="form-check mt-3">
          <input class="form-check-input"
                 type="checkbox"
                 id="artist_verification"
                 name="artist_verification"
                 value="1"
                 data-owner-artist-autocomplete-target="verification">
          <label class="form-check-label" for="artist_verification">
            <strong>Yes, this is the correct artist for this event</strong>
          </label>
        </div>
      </div>

      <!-- Manual fallback -->
      <div class="form-check mb-3">
        <input class="form-check-input"
               type="checkbox"
               id="artist_gate_checkbox"
               data-owner-artist-autocomplete-target="gateCheckbox"
               data-action="change->owner-artist-autocomplete#toggleGate">
        <label class="form-check-label" for="artist_gate_checkbox">
          I can't find the artist
        </label>
      </div>

      <div class="mb-3 d-none" data-owner-artist-autocomplete-target="manualFieldsWrapper">
        <%= f.label :artist_name, "Artist Name", class: "form-label" %>
        <%= f.text_field :artist_name,
              class: "form-control #{'is-invalid' if @event.errors[:artist_name].present?}",
              data: { owner_artist_autocomplete_target: "manualNameField" } %>
      </div>
    </div>

    <!-- Venue Selection (Editable for Admin) -->
    <div class="mb-3" data-controller="venue-autocomplete">
      <%= label_tag "venue_search", "Search for Venue", class: "form-label fw-bold" %>
      <%= text_field_tag "venue_search", @event.venue.name,
        placeholder: "Start typing venue name...",
        class: "form-control",
        data: {
          action: "input->venue-autocomplete#search",
          venue_autocomplete_target: "input"
        } %>

      <ul class="list-group mt-1" data-venue-autocomplete-target="results"></ul>

      <%= hidden_field_tag "event[venue_slug]", @event.venue.slug,
          data: { 
            venue_autocomplete_target: "hidden",
            time_options_target: "venue",
            action: "change->time-options#venueChanged"
          } %>

      <div class="mt-2 text-center">
        <%= link_to "Can't find the venue? Add it here", new_venue_request_path, 
      class: "btn btn-outline-secondary btn-sm",
      target: "_blank" %>
      </div>
      
      <!-- Venue verification section -->
      <div class="border border-info rounded p-3 bg-info-subtle mt-3 d-none" data-venue-autocomplete-target="details">
        <h5>Does this look right?</h5>
        <p><strong>Name:</strong> <span data-venue-autocomplete-target="name"></span></p>
        <p><strong>Address:</strong> <span data-venue-autocomplete-target="address"></span></p>

        <div class="form-check mt-3">
          <input class="form-check-input" 
                 type="checkbox" 
                 id="venue_verification" 
                 name="venue_verification" 
                 value="1"
                 data-venue-autocomplete-target="verification"
                 data-action="change->venue-autocomplete#toggleSubmit">
          <label class="form-check-label" for="venue_verification">
            <strong>Yes, this is the correct venue for this event</strong>
          </label>
        </div>
      </div>
    </div>

    <!-- Category Dropdown -->
    <div class="mb-3">
      <%= f.label :category, class: "form-label fw-bold" %>
      <%= f.select :category, 
            Artist::PERFORMANCE_TYPES.map { |type| [type, type] }, 
            { selected: @event.category }, 
            { 
              class: "form-select", 
              required: true,
              data: {
                owner_category_warning_target: "category",
                action: "change->owner-category-warning#checkCategory"
              }
            } %>
      <div class="small text-muted mt-1 d-none" data-owner-category-warning-target="warning"></div>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <%= f.label :description, class: "form-label fw-bold" %>
      <%= f.text_area :description,
            class: "form-control",
            placeholder: "Describe the event",
            rows: 3 %>
    </div>

    <!-- Date Dropdown -->
    <div class="mb-3">
      <%= f.label :date, class: "form-label fw-bold" %>
      <%= f.select :date, [["Select date", ""]],
      {},
      class: "form-select",
      required: true,
      data: {
        time_options_target: "date",
        default_value: (@event.start_time&.in_time_zone(@event.venue.tz_name)&.to_date&.to_s),
        action: "change->time-options#updateStartTimes"
      } %>
    </div>

    <!-- Start Time Dropdown -->
    <div class="mb-3">
      <%= f.label :start_time, "Start Time", class: "form-label fw-bold" %>
      <%= f.select :start_time, [["Select start time", ""]],
      {},
      class: "form-select",
      required: true,
      data: {
        time_options_target: "startTime",
        default_value: (@event.start_time&.in_time_zone(@event.venue.tz_name)&.strftime("%H:%M")),
        action: "change->time-options#updateEndTimes"
      } %>
    </div>

    <!-- End Time Dropdown -->
    <div class="mb-3">
      <%= f.label :end_time, "End Time", class: "form-label fw-bold" %>
      <%= f.select :end_time, [["Select end time", ""]],
      {},
      class: "form-select",
      required: true,
      data: {
        time_options_target: "endTime",
        default_value: (@event.end_time&.in_time_zone(@event.venue.tz_name)&.strftime("%H:%M"))
      } %>
    </div>

    <!-- Cover Checkbox -->
    <div class="form-check mb-3">
      <%= f.check_box :cover,
            class: "form-check-input",
            id: "event_cover",
            onchange: "toggleCoverAmount()" %>
      <%= f.label :cover, "Cover Charge?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Cover Amount Field -->
    <div class="mb-3" id="cover-amount-field" style="display: <%= @event.cover? ? 'block' : 'none' %>;">
      <%= f.label :cover_amount, "Cover Amount ($)", class: "form-label fw-bold" %>
      <%= f.number_field :cover_amount,
            class: "form-control",
            placeholder: "Enter amount",
            min: 1,
            step: 1 %>
    </div>

    <!-- Outdoors Checkbox -->
    <div class="form-check mb-4">
      <%= f.check_box :indoors, 
    { checked: @event.outdoors?, class: "form-check-input" }, 
    "0", 
    "1" %>
      <%= f.label :indoors, "Outdoors?", class: "form-check-label fw-bold" %>
    </div>

    <!-- Submit Button -->
    <div class="d-grid">
      <%= f.submit "Update Event", class: "btn btn-primary" %>
    </div>

    <!-- error block -->
    <% if @event.errors[:base].any? %>
      <div class="text-danger small mt-2"><%= @event.errors[:base].first %></div>
    <% end %>

  <% end %>
</div>
